<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xmlns:context="http://www.springframework.org/schema/context"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/aop
        http://www.springframework.org/schema/aop/spring-aop.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context.xsd">
    <context:component-scan base-package="com.stevejrong.music.factory.module,com.stevejrong.music.factory.logs.aspect"/>

    <!-- 系统基础配置 -->
    <bean id="baseConfig" class="com.stevejrong.music.factory.config.BaseConfig">
        <!-- Spring配置文件的文件名称 -->
        <property name="springConfigurationFileName" value="application-bean.xml"/>
    </bean>
    <!-- 分析和补全音乐信息配置 -->
    <bean id="analysisAndComplementsMusicInfoConfig" class="com.stevejrong.music.factory.config.AnalysisAndComplementsMusicInfoConfig">
        <!-- 原始音频文件存放目录 -->
        <property name="musicFileDirectoryOfOriginal" value="/Users/stevejrong/Desktop/old"/>
    </bean>
    <bean id="convertMusicFileConfig" class="com.stevejrong.music.factory.config.ConvertMusicFileConfig">
        <!-- 转换后的音频文件存放目录 -->
        <property name="musicFileDirectoryOfConverted" value="/Users/stevejrong/Desktop/new"/>
        <!-- FFmpeg组件的ffmpeg文件路径 -->
        <property name="ffmpegFileDirectory" value="/Volumes/Document/Softwares/ffmpeg-4.1-macos64-static/bin/ffmpeg"/>
        <!-- FFmpeg组件的ffprobe文件路径 -->
        <property name="ffprobeFileDirectory" value="/Volumes/Document/Softwares/ffmpeg-4.1-macos64-static/bin/ffprobe"/>
    </bean>
    <!-- 系统配置 -->
    <bean id="systemConfig" class="com.stevejrong.music.factory.config.SystemConfig">
        <property name="baseConfig" ref="baseConfig"/>
        <property name="analysisAndComplementsMusicInfoConfig" ref="analysisAndComplementsMusicInfoConfig"/>
        <property name="convertMusicFileConfig" ref="convertMusicFileConfig"/>
    </bean>

    <!--Flac格式的音频文件，元数据解析器-->
    <bean id="flacMetadataQueryResolver" class="com.stevejrong.music.factory.analysis.metadata.query.resolver.impl.FlacMetadataQueryResolver"/>
    <!--MP3格式的音频文件，元数据解析器-->
    <bean id="mp3MetadataQueryResolver" class="com.stevejrong.music.factory.analysis.metadata.query.resolver.impl.Mp3MetadataQueryResolver"/>

    <!--Flac格式的音频文件，元数据存储器-->
    <bean id="flacMetadataPersistResolver" class="com.stevejrong.music.factory.analysis.metadata.persist.resolver.impl.FlacMetadataPersistResolver"/>
    <!--MP3格式的音频文件，元数据存储器-->
    <bean id="mp3MetadataPersistResolver" class="com.stevejrong.music.factory.analysis.metadata.persist.resolver.impl.Mp3MetadataPersistResolver"/>

    <!--QQ音乐第三方数据源-->
    <bean id="qqMusicDataSource" class="com.stevejrong.music.factory.analysis.datasource.impl.qqmusic.QQMusicDataSourceImpl"/>
    <!--QQ音乐歌曲搜索返回的音乐信息解析器-->
    <bean id="qqMusicInfoResolver" class="com.stevejrong.music.factory.analysis.datasource.impl.qqmusic.QQMusicInfoResolver"/>

    <!-- M4A（AAC）音频格式转换为FLAC音频文件格式转换器 -->
    <bean id="m4aAacToFlacConverter" class="com.stevejrong.music.factory.transcode.converter.impl.M4aAacToFlacConverter">
        <property name="systemConfig" ref="systemConfig"/>
    </bean>
    <!-- APE音频格式转换为FLAC音频格式转换器 -->
    <bean id="apeToFlacConverter" class="com.stevejrong.music.factory.transcode.converter.impl.ApeToFlacConverter">
        <property name="systemConfig" ref="systemConfig"/>
    </bean>
    <!-- WAV音频格式转换为FLAC音频格式转换器 -->
    <bean id="wavToFlacConverter" class="com.stevejrong.music.factory.transcode.converter.impl.WavToFlacConverter">
        <property name="systemConfig" ref="systemConfig"/>
    </bean>

    <!--业务模块：分析原始音频文件-->
    <bean id="analysisOriginalMusicFileModule" class="com.stevejrong.music.factory.module.impl.AnalysisOriginalMusicFileModule">
        <property name="systemConfig" ref="systemConfig"/>
    </bean>

    <!--业务模块：补全音乐元数据信息-->
    <bean id="complementsMusicInfoModule" class="com.stevejrong.music.factory.module.impl.ComplementsMusicInfoModule">
        <property name="systemConfig" ref="systemConfig"/>
        <property name="partnerDataSourceBeanName" value="qqMusicDataSource"/>
        <property name="partnerMusicInfoResolverBeanName" value="qqMusicInfoResolver"/>
    </bean>

    <!--业务模块：音频文件格式转换-->
    <bean id="musicFormatConvertModule" class="com.stevejrong.music.factory.module.impl.MusicFormatConvertModule">
        <property name="systemConfig" ref="systemConfig"/>
        <!-- 某一种受支持的音频格式，转换为FLAC音频格式，其音频转换器的使用规则 -->
        <property name="rulesByMusicConverter">
            <map>
                <!-- M4A（AAC）音频格式转换为FLAC音频格式 -->
                <entry key="m4a_aac" value="m4aAacToFlacConverter"/>
                <!-- APE音频格式转换为FLAC音频格式 -->
                <entry key="ape" value="apeToFlacConverter"/>
                <!-- WAV音频格式转换为FLAC音频格式 -->
                <entry key="wav" value="wavToFlacConverter"/>
            </map>
        </property>
    </bean>

    <!--日志记录基础Bean-->
    <bean id="businessModuleAdvice" class="com.stevejrong.music.factory.logs.aspect.BusinessModuleAdvice"/>

    <!--分析原始音频文件的日志记录业务类-->
    <bean id="analysisOriginalMusicFileModuleLogService" class="com.stevejrong.music.factory.logs.service.impl.AnalysisOriginalMusicFileModuleLogServiceImpl"/>
    <!--补全音乐元数据信息的日志记录业务类-->
    <bean id="complementsMusicInfoModuleLogService" class="com.stevejrong.music.factory.logs.service.impl.ComplementsMusicInfoModuleLogServiceImpl"/>

    <!-- 日志切面 -->
    <aop:aspectj-autoproxy/>
    <aop:config proxy-target-class="true">
        <!--分析原始音频文件 切入点-->
        <aop:pointcut expression="execution(* com.stevejrong.music.factory.module.impl.AnalysisOriginalMusicFileModule.doAction(..))" id="analysisOriginalMusicFileModulePointcut"/>

        <!--补全音乐元数据信息 切入点-->
        <aop:pointcut expression="execution(* com.stevejrong.music.factory.module.impl.ComplementsMusicInfoModule.doAction(..))" id="complementsMusicInfoModulePointcut"/>

        <aop:aspect ref="businessModuleAdvice">
            <aop:after-returning method="afterReturn" returning="returnObject" pointcut-ref="analysisOriginalMusicFileModulePointcut"/>
            <aop:after-throwing method="afterException" arg-names="exception" throwing="exception" pointcut-ref="analysisOriginalMusicFileModulePointcut"/>

            <aop:after-returning method="afterReturn" returning="returnObject" pointcut-ref="complementsMusicInfoModulePointcut"/>
            <aop:after-throwing method="afterException" arg-names="exception" throwing="exception" pointcut-ref="complementsMusicInfoModulePointcut"/>
        </aop:aspect>
    </aop:config>
</beans>